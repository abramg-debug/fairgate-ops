<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FairGate Ops Composer (V1)</title>

<style>
:root{
  --bg:#0b1220; --card:#121a2b; --text:#e8eefc; --muted:#9fb0d8;
  --accent:#3b82f6; --ok:#17c964; --err:#f31260; --border:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg); color:var(--text);
}
.wrap{max-width:1040px;margin:28px auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:0 10px 28px rgba(0,0,0,.35);
  padding:16px;
  margin-bottom:14px;
}
h1{margin:0 0 8px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
.sub{color:var(--muted);font-size:13px; margin:0 0 10px}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,textarea,select{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;
}
textarea{min-height:90px;resize:vertical}
.row{display:grid;gap:12px}
.row.two{grid-template-columns:1fr 1fr}
.row.three{grid-template-columns:1fr 1fr 1fr}
.btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
button{
  border:1px solid var(--border);
  background:rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
}
button.primary{background:rgba(59,130,246,.18)}
button.good{background:rgba(23,201,100,.18)}
button.warn{background:rgba(243,18,96,.18)}
.preview{
  white-space:pre-wrap;
  font-family:ui-monospace,Menlo,Consolas,monospace;
  font-size:12px;
  background:rgba(0,0,0,.25);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  min-height:120px;
}
.status{margin-top:8px;font-size:13px}
.ok{color:var(--ok)}
.err{color:var(--err)}
.notice{
  border:1px solid rgba(59,130,246,.35);
  background:rgba(59,130,246,.12);
  border-radius:12px;
  padding:10px 12px;
  color:var(--text);
  font-size:12px;
  line-height:1.35;
}
code{font-family:ui-monospace,Menlo,Consolas,monospace}
.small{font-size:12px;color:var(--muted)}
.checkgrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}
@media(min-width:900px){
  .checkgrid{grid-template-columns: repeat(4, minmax(0,1fr));}
}
.check{
  display:flex; gap:8px; align-items:flex-start;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 10px;
  background:rgba(255,255,255,.02);
}
.check input{width:auto; margin-top:2px}
.badge{
  display:inline-block;
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--muted);
}
.kv{
  display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;
}
.kv span{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">

<!-- Preferences -->
<div class="card">
  <h1>FairGate Ops Composer (V1)</h1>
  <p class="sub">Dispatch & Closure email generator (Gmail Web → always uses helpdesk)</p>

  <div class="notice">
    This web app opens Gmail compose using <code>helpdesk@nexien.com</code> via <code>authuser</code>.
    <br><b>Requirement:</b> <code>helpdesk@nexien.com</code> must already be logged into this browser profile.
  </div>

  <div class="row two" style="margin-top:10px">
    <div>
      <label>To (Google Group)</label>
      <input id="toAddr" placeholder="fairgate-dispatch@yourdomain.com">
      <div class="small" style="margin-top:6px">Tip: put your main distro here (one address).</div>
    </div>

    <div>
      <label>Manual CC Extras (optional)</label>
      <input id="ccManual" placeholder="someone@domain.com, another@domain.com">
      <div class="small" style="margin-top:6px">Use this for one-offs. Groups below auto-add CCs.</div>
    </div>
  </div>

  <label style="margin-top:14px">CC Groups</label>
  <div class="checkgrid">
    <label class="check">
      <input type="checkbox" id="ccg_nexien">
      <div>
        <div><b>Nexien</b> <span class="badge" id="count_nexien"></span></div>
        <div class="small">Internal team</div>
      </div>
    </label>

    <label class="check">
      <input type="checkbox" id="ccg_metro">
      <div>
        <div><b>Metro</b> <span class="badge" id="count_metro"></span></div>
        <div class="small">Metro stakeholders</div>
      </div>
    </label>

    <label class="check">
      <input type="checkbox" id="ccg_straffic">
      <div>
        <div><b>STraffic</b> <span class="badge" id="count_straffic"></span></div>
        <div class="small">STraffic contacts</div>
      </div>
    </label>

    <label class="check">
      <input type="checkbox" id="ccg_cubic">
      <div>
        <div><b>Cubic</b> <span class="badge" id="count_cubic"></span></div>
        <div class="small">Cubic dispatch/support</div>
      </div>
    </label>
  </div>

  <label style="margin-top:14px">Computed CC (preview)</label>
  <input id="ccComputed" readonly>

  <div class="btns">
    <button class="primary" id="openHelpdesk">Open Helpdesk Inbox</button>
    <button class="primary" id="savePrefs">Save</button>
    <button id="loadPrefs">Reload</button>
    <button class="warn" id="clearPrefs">Clear</button>
  </div>
  <div id="prefStatus" class="status"></div>
</div>

<!-- Ticket Fields -->
<div class="card">
  <h2>Ticket Fields</h2>

  <div class="row two">
    <div>
      <label>Station Name</label>
      <input id="station" list="stations" placeholder="Start typing… (filters gates)">
      <datalist id="stations"></datalist>
      <div class="kv">
        <span>Line: <b id="lineOut">—</b></span>
        <span>Site ID: <b id="siteOut">—</b></span>
        <span>Gates loaded: <b id="gateCountOut">0</b></span>
      </div>
    </div>

    <div>
      <label>Gate # (Faregate ID)</label>
      <input id="fgid" list="gates" placeholder="Start typing… (filtered by station)">
      <datalist id="gates"></datalist>
      <div class="small" style="margin-top:6px">Pick from filtered list, or type manually if needed.</div>
    </div>
  </div>

  <div class="row two">
    <div>
      <label>Ticket ID</label>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-weight:700;letter-spacing:.4px">FM-</span>
        <input id="ticketId" placeholder="12345">
      </div>
    </div>

    <div>
      <label>Technician</label>
      <select id="tech">
        <option value="">Select technician…</option>
        <option>Abram Gearig</option>
        <option>Aijaz Sabir</option>
        <option>Asanti Hudson</option>
        <option>Charles Lee</option>
        <option>Demetrius Harper</option>
        <option>Devon Johnson</option>
        <option>Francisco Leal</option>
        <option>Gunsuk Yang</option>
        <option>Hector Moreno</option>
        <option>Jimmy Zone</option>
        <option>Jose Juarez</option>
        <option>Joshua Almeda</option>
        <option>Julio Martinez</option>
        <option>Juan Hernandez</option>
        <option>Pablo Almeda Rodriguez</option>
        <option>Revic Cho</option>
        <option>Roger Diaz</option>
      </select>
    </div>
  </div>

  <div class="row three">
    <div>
      <label>Reported Date/Time</label>
      <input id="dtReported" placeholder="MM/DD/YYYY HH:MM   e.g., 12/18/2025 17:46">
    </div>
    <div>
      <label>Dispatch Date/Time</label>
      <input id="dtDispatch" placeholder="MM/DD/YYYY HH:MM   e.g., 12/19/2025 08:06">
    </div>
    <div>
      <label>Arrival Date/Time</label>
      <input id="dtArrival" placeholder="MM/DD/YYYY HH:MM   e.g., 12/19/2025 08:09">
    </div>
  </div>

  <label>Issue Details</label>
  <textarea id="issue" placeholder="Describe the issue…"></textarea>

  <label>Actions Taken</label>
  <textarea id="actions" placeholder="What was done…"></textarea>

  <div class="row two">
    <div>
      <label>Faregate Status</label>
      <select id="statusSel">
        <option value="">Select…</option>
        <option>Closed</option>
        <option>In Service</option>
        <option>Out of Service</option>
        <option>Degrade Mode</option>
        <option>Pending Parts</option>
      </select>
    </div>
    <div>
      <label>Cause (if known)</label>
      <input id="cause" placeholder="Optional">
    </div>
  </div>

  <div class="btns">
    <button class="primary" id="build">Build Emails + Daily Line</button>
    <button id="clearFields">Clear Ticket Fields</button>
  </div>
  <div id="buildStatus" class="status"></div>
</div>

<!-- Outputs -->
<div class="card">
  <h2>Outputs</h2>

  <label>Dispatch Email</label>
  <div id="dispatchPreview" class="preview"></div>
  <div class="btns">
    <button class="good" id="copyDispatch">Copy</button>
    <button class="primary" id="openDispatch">Open Gmail (helpdesk)</button>
  </div>

  <label>Ticket Closed Email</label>
  <div id="closedPreview" class="preview"></div>
  <div class="btns">
    <button class="good" id="copyClosed">Copy</button>
    <button class="primary" id="openClosed">Open Gmail (helpdesk)</button>
  </div>

  <label>Daily Report Line (optional helper)</label>
  <div id="dailyPreview" class="preview"></div>
  <div class="btns">
    <button class="good" id="copyDaily">Copy Daily Line (tabs)</button>
  </div>

  <div id="actionStatus" class="status"></div>
</div>

</div>

<script>
const $ = id => document.getElementById(id);
const prefsKey = "fairgate_prefs_v1";
const HELP_DESK = "helpdesk@nexien.com";

/**
 * Embedded site dataset.
 * Format: Line,Site ID,Site Name,Gate #
 */
const SITE_DATA_CSV = `
Line,Site ID,Site Name,Gate #
A,144,Firestone,00605
A,144,Firestone,00606
A,144,Firestone,00608
A,144,Firestone,00609
A,145,Willowbrook - Rosa Parks,00333
A,145,Willowbrook - Rosa Parks,00334
A,145,Willowbrook - Rosa Parks,00335
A,145,Willowbrook - Rosa Parks,00337
A,145,Willowbrook - Rosa Parks,00340
A,145,Willowbrook - Rosa Parks,00342
A,145,Willowbrook - Rosa Parks,00343
A,145,Willowbrook - Rosa Parks,00345
A,145,Willowbrook - Rosa Parks,00346
A,145,Willowbrook - Rosa Parks,00349
A,145,Willowbrook - Rosa Parks,00350
A,145,Willowbrook - Rosa Parks,00351
A,145,Willowbrook - Rosa Parks,00353
A,145,Willowbrook - Rosa Parks,00357
A,145,Willowbrook - Rosa Parks,00358
A,145,Willowbrook - Rosa Parks,00450
A,145,Willowbrook - Rosa Parks,00451
A,145,Willowbrook - Rosa Parks,00452
A,145,Willowbrook - Rosa Parks,00453
A,145,Willowbrook - Rosa Parks,00454
A,145,Willowbrook - Rosa Parks,00455
A,145,Willowbrook - Rosa Parks,00456
A,145,Willowbrook - Rosa Parks,00458
A,145,Willowbrook - Rosa Parks,00459
A,145,Willowbrook - Rosa Parks,00460
A,167,Lake,00508
A,167,Lake,00510
A,168,Allen,00505
A,168,Allen,00506
A,168,Allen,00507
A,2975,Glendora,00462
A,2975,Glendora,00463
A,2975,Glendora,00466
A,2975,Glendora,00467
A,2976,San Dimas,00470
A,2976,San Dimas,00471
A,2977,La Verne,00478
A,2977,La Verne,00479
A,2977,La Verne,00482
A,2977,La Verne,00483
A,2978,Pomona,00486
A,2978,Pomona,00487
A,2978,Pomona,00488
A,2978,Pomona,00489
A,2978,Pomona,00490
A,2978,Pomona,00493
A,2978,Pomona,00494
A,2978,Pomona,00497
A,2978,Pomona,00498
B,104,Westlake/MacArthur Park,00901
B,104,Westlake/MacArthur Park,00902
B,104,Westlake/MacArthur Park,00903
B,104,Westlake/MacArthur Park,00904
B,104,Westlake/MacArthur Park,00905
B,104,Westlake/MacArthur Park,00906
B,104,Westlake/MacArthur Park,00907
B,104,Westlake/MacArthur Park,00908
B,104,Westlake/MacArthur Park,00909
B,104,Westlake/MacArthur Park,00910
B,120,North Hollywood - Red,00154
B,120,North Hollywood - Red,00155
B,120,North Hollywood - Red,00156
B,120,North Hollywood - Red,00157
B,120,North Hollywood - Red,00158
B,120,North Hollywood - Red,00161
B,120,North Hollywood - Red,00162
B,120,North Hollywood - Red,00163
B,120,North Hollywood - Red,00164
B,120,North Hollywood - Red,00165
B,120,North Hollywood - Red,00166
B,123,Pershing Square,00035
B,123,Pershing Square,00036
B,123,Pershing Square,00037
B,123,Pershing Square,00038
B,123,Pershing Square,00039
B,123,Pershing Square,00040
B,123,Pershing Square,00041
B,123,Pershing Square,00043
B,123,Pershing Square,00044
B,123,Pershing Square,00045
B,123,Pershing Square,00046
B,123,Pershing Square,00047
B,124,7th Street/Metro Center,00049
B,124,7th Street/Metro Center,00050
B,124,7th Street/Metro Center,00051
B,124,7th Street/Metro Center,00052
B,124,7th Street/Metro Center,00054
B,124,7th Street/Metro Center,00055
B,124,7th Street/Metro Center,00056
B,124,7th Street/Metro Center,00057
B,124,7th Street/Metro Center,00059
B,124,7th Street/Metro Center,00060
B,124,7th Street/Metro Center,00061
B,124,7th Street/Metro Center,00062
B,124,7th Street/Metro Center,00064
B,124,7th Street/Metro Center,00065
B,124,7th Street/Metro Center,00066
B,124,7th Street/Metro Center,00067
B,124,7th Street/Metro Center,00069
B,124,7th Street/Metro Center,00070
B,124,7th Street/Metro Center,00071
B,125,Wilshire/Vermont,00087
B,125,Wilshire/Vermont,00088
B,125,Wilshire/Vermont,00089
B,125,Wilshire/Vermont,00090
B,125,Wilshire/Vermont,00091
B,125,Wilshire/Vermont,00095
B,125,Wilshire/Vermont,00096
B,129,Vermont/Santa Monica,00104
B,129,Vermont/Santa Monica,00105
B,129,Vermont/Santa Monica,00106
B,129,Vermont/Santa Monica,00107
B,129,Vermont/Santa Monica,00110
B,129,Vermont/Santa Monica,00111
B,131,Hollywood/Western,00112
B,131,Hollywood/Western,00124
B,131,Hollywood/Western,00125
B,131,Hollywood/Western,00126
B,131,Hollywood/Western,00127
B,131,Hollywood/Western,00128
B,122,Civic Center,00026
B,122,Civic Center,00027
B,122,Civic Center,00028
B,122,Civic Center,00029
B,122,Civic Center,00030
B,122,Civic Center,00031
B,122,Civic Center,00032
B,122,Civic Center,00911
B,122,Civic Center,00912
B,122,Civic Center,00913
K,2941,LAX/MTC,00206
K,2941,LAX/MTC,00207
K,2941,LAX/MTC,00208
K,2941,LAX/MTC,00209
K,2941,LAX/MTC,00210
K,2941,LAX/MTC,00211
K,2941,LAX/MTC,00213
K,2941,LAX/MTC,00214
K,2941,LAX/MTC,00215
K,2941,LAX/MTC,00216
K,2941,LAX/MTC,00217
K,2941,LAX/MTC,00218
K,171,Dougls,00436
K,171,Dougls,00437
K,171,Dougls,00438
K,171,Dougls,00439
K,171,Dougls,00530
K,171,Dougls,00531
K,171,Dougls,00440
K,171,Dougls,00441
K,171,Dougls,00442
K,171,Dougls,00475
K,171,Dougls,00476
C,174,Aviation/Imperial,00411
C,174,Aviation/Imperial,00412
C,174,Aviation/Imperial,00413
C,174,Aviation/Imperial,00415
C,174,Aviation/Imperial,00416
C,174,Aviation/Imperial,00417
C,174,Aviation/Imperial,00472
C,174,Aviation/Imperial,00474
C,60,Norwalk,00307
C,60,Norwalk,00308
C,60,Norwalk,00532
C,60,Norwalk,00533
C,60,Norwalk,00534
C,60,Norwalk,00535
C,60,Norwalk,00300
C,60,Norwalk,00301
C,60,Norwalk,00302
C,60,Norwalk,00303
C,60,Norwalk,00304
C,60,Norwalk,00305
D,2986,Wilshire/La Brea,00184
D,2986,Wilshire/La Brea,00185
D,2986,Wilshire/La Brea,00186
D,2986,Wilshire/La Brea,00187
D,2987,Wilshire/Fairfax,00190
D,2987,Wilshire/Fairfax,00191
D,2987,Wilshire/Fairfax,00192
D,2987,Wilshire/Fairfax,00193
D,2988,Wilshire/La Cienega,00916
D,2988,Wilshire/La Cienega,00917
D,2988,Wilshire/La Cienega,00918
D,2988,Wilshire/La Cienega,00919
D,2988,Wilshire/La Cienega,00920
D,2988,Wilshire/La Cienega,00921
D,2988,Wilshire/La Cienega,00922
`.trim();

// CC groups
const CC_GROUPS = {
  nexien: [
    "wilson.h@nexien.com","revic.c@nexien.com","john.h@nexien.com","abram.g@nexien.com","gunsuk.y@nexien.com",
    "charles.l@nexien.com","jimmy.z@nexien.com","bok.l@nexien.com","jose.j@nexien.com","juan.h@nexien.com",
    "roger.d@nexien.com","pablo.a@nexien.com","devon.j@nexien.com","asanti.h@nexien.com","rafael.t@nexien.com",
    "francisco.l@nexien.com","joshua.a@nexien.com","aijaz.s@nexien.com","julio.m@nexien.com","hector.m@nexien.com",
    "julio.n@nexien.com","demetrius.h@nexien.com"
  ],
  metro: ["JacksonKA@metro.net","villanuevar@metro.net","AlmedaL@metro.net","NangleC@metro.net"],
  straffic: [
    "kihyun38@straffic.co.kr","jelee127@straffic.co.kr","twinsi@straffic.co.kr","jwyoo@straffic.co.kr",
    "shsong@straffic.co.kr","yssong@straffic.co.kr","yosep.choi@straffic.com","jeonsoyoung0612@straffic.co.kr",
    "jaeiklee@straffic.co.kr","juyoung.lee@straffic.co.kr"
  ],
  cubic: ["ladispatch@cubic.com","Manuel.Salinas@cubic.com","Allan.Lee@cubic.com","Nestor.Gonzalez@cubic.com"]
};

function setStatus(id, msg, kind){
  const el = $(id);
  el.textContent = msg || "";
  el.className = "status " + (kind || "");
}

function normalizeEmailList(s){
  return (s || "")
    .split(/[,;\n]+/)
    .map(x => x.trim())
    .filter(Boolean);
}

function uniqueEmails(list){
  const seen = new Set();
  const out = [];
  for(const e of list){
    const key = e.toLowerCase();
    if(!seen.has(key)){
      seen.add(key);
      out.push(e);
    }
  }
  return out;
}

function computeCC(){
  const selected = [];
  if($("ccg_nexien").checked) selected.push(...CC_GROUPS.nexien);
  if($("ccg_metro").checked) selected.push(...CC_GROUPS.metro);
  if($("ccg_straffic").checked) selected.push(...CC_GROUPS.straffic);
  if($("ccg_cubic").checked) selected.push(...CC_GROUPS.cubic);

  const manual = normalizeEmailList($("ccManual").value);
  const finalList = uniqueEmails([...selected, ...manual]);

  const ccStr = finalList.join(", ");
  $("ccComputed").value = ccStr;
  return ccStr;
}

function savePrefs(){
  localStorage.setItem(prefsKey, JSON.stringify({
    to: $("toAddr").value.trim(),
    ccManual: $("ccManual").value.trim(),
    groups: {
      nexien: $("ccg_nexien").checked,
      metro: $("ccg_metro").checked,
      straffic: $("ccg_straffic").checked,
      cubic: $("ccg_cubic").checked
    }
  }));
  setStatus("prefStatus", "Saved.", "ok");
}

function loadPrefs(){
  const p = JSON.parse(localStorage.getItem(prefsKey) || "{}");
  $("toAddr").value = p.to || "";
  $("ccManual").value = p.ccManual || "";

  const g = p.groups || {};
  $("ccg_nexien").checked = !!g.nexien;
  $("ccg_metro").checked = !!g.metro;
  $("ccg_straffic").checked = !!g.straffic;
  $("ccg_cubic").checked = !!g.cubic;

  computeCC();
}

function clearPrefs(){
  localStorage.removeItem(prefsKey);
  $("toAddr").value = "";
  $("ccManual").value = "";
  $("ccg_nexien").checked = false;
  $("ccg_metro").checked = false;
  $("ccg_straffic").checked = false;
  $("ccg_cubic").checked = false;
  computeCC();
  setStatus("prefStatus", "Cleared.", "ok");
}

// Gmail compose URL (forces authuser to helpdesk)
function gmailCompose(to, cc, subject, body){
  const p = new URLSearchParams({
    view: "cm",
    fs: "1",
    to: to || "",
    su: subject || "",
    body: body || "",
    authuser: HELP_DESK
  });
  if (cc) p.set("cc", cc);
  return "https://mail.google.com/mail/?" + p.toString();
}

function gmailInbox(){
  const p = new URLSearchParams({ authuser: HELP_DESK });
  return "https://mail.google.com/mail/?" + p.toString();
}

// Parse "MM/DD/YYYY HH:MM" (24hr). Returns Date or null.
function parseMDYHM(s){
  const t = (s || "").trim();
  if(!t) return null;
  const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})$/);
  if(!m) return null;
  const mm = Number(m[1]), dd = Number(m[2]), yyyy = Number(m[3]);
  const HH = Number(m[4]), MI = Number(m[5]);
  const d = new Date(yyyy, mm-1, dd, HH, MI, 0, 0);
  if(Number.isNaN(d.getTime())) return null;
  return d;
}

// Format duration ms -> H:MM:SS
function formatDuration(ms){
  if(ms == null || ms < 0) return "";
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

async function copyText(txt){
  try {
    await navigator.clipboard.writeText(txt);
    setStatus("actionStatus", "Copied.", "ok");
  } catch(e){
    setStatus("actionStatus", "Copy blocked by browser. Try a different browser or use HTTPS.", "err");
  }
}

/** ---------- Station/Gate filtering ---------- **/
let stationIndex = new Map(); // stationName -> { line, siteId, gates: [..] }

function parseSites(){
  const lines = SITE_DATA_CSV.split("\n")
    .map(l => l.trim())
    .filter(l => l && !l.startsWith("Line,"));
  stationIndex = new Map();

  for(const row of lines){
    const parts = row.split(",").map(x => x.trim());
    if(parts.length < 4) continue;
    const [line, siteId, station, gate] = parts;

    if(!stationIndex.has(station)){
      stationIndex.set(station, { line, siteId, gates: [] });
    }
    stationIndex.get(station).gates.push(gate);
  }

  for(const [station, obj] of stationIndex.entries()){
    obj.gates = Array.from(new Set(obj.gates)).sort((a,b)=>Number(a)-Number(b));
  }
}

function populateStationDatalist(){
  const dl = $("stations");
  dl.innerHTML = "";
  const stations = Array.from(stationIndex.keys()).sort((a,b)=>a.localeCompare(b));
  for(const st of stations){
    const opt = document.createElement("option");
    opt.value = st;
    dl.appendChild(opt);
  }
}

function setGatesForStation(station){
  const gatesDL = $("gates");
  gatesDL.innerHTML = "";

  const info = stationIndex.get(station);
  if(!info){
    $("lineOut").textContent = "—";
    $("siteOut").textContent = "—";
    $("gateCountOut").textContent = "0";
    return;
  }

  $("lineOut").textContent = info.line;
  $("siteOut").textContent = info.siteId;
  $("gateCountOut").textContent = String(info.gates.length);

  for(const g of info.gates){
    const opt = document.createElement("option");
    opt.value = g; // show raw list (with leading zeros)
    gatesDL.appendChild(opt);
  }
}

// Strip leading zeros for gate numbers like 00498 -> 498
function normalizeGateNumber(val){
  const t = (val || "").trim();
  if(!t) return "";
  if(/^\d+$/.test(t)){
    // Number("00000") -> 0, keep "0" as "0"
    return String(Number(t));
  }
  return t; // if non-numeric, leave as-is
}

/** ---------- Build outputs ---------- **/
function build(){
  const station = $("station").value.trim();
  const fgidRawInput = $("fgid").value.trim();
  const fgid = normalizeGateNumber(fgidRawInput); // <-- normalized here
  const ticketIdRaw = $("ticketId").value.trim();
  const issue = $("issue").value.trim();
  const actions = $("actions").value.trim();
  const status = $("statusSel").value;
  const cause = $("cause").value.trim();
  const tech = $("tech").value;

  const ticket = ticketIdRaw ? `FM-${ticketIdRaw}` : "";

  const dtReportedTxt = $("dtReported").value.trim();
  const dtDispatchTxt = $("dtDispatch").value.trim();
  const dtArrivalTxt  = $("dtArrival").value.trim();

  const dtDispatch = parseMDYHM(dtDispatchTxt);
  const dtArrival  = parseMDYHM(dtArrivalTxt);
  const duration = (dtDispatch && dtArrival) ? formatDuration(dtArrival.getTime() - dtDispatch.getTime()) : "";

  if(!station || !fgid || !ticket || !issue){
    setStatus("buildStatus", "Fill Station Name, Gate #, Ticket ID (FM-), and Issue Details.", "err");
  } else {
    setStatus("buildStatus", "Built outputs.", "ok");
  }

  // DISPATCH (exact format you provided)
  const dispSub = `Service Dispatched "${station || "Station Name"}" – ${fgid || "FG ID"} – ${ticket || "Ticket ID"}`;
  const dispBody = [
    "Service Dispatched",
    "",
    `TICKET ID: ${ticket}`,
    `STATION NAME: ${station}`,
    `FAREGATE ID: ${fgid}`,
    `ISSUE DETAILS: ${issue}`,
    `ACTIONS TAKEN: ${actions}`,
    `FAREGATE STATUS: ${status}`,
    `CAUSE (IF KNOWN): ${cause}`
  ].join("\n");

  // CLOSED (unchanged for now)
  const closeSub = `Ticket Closed – ${station || "Station"} – ${fgid || "FG"} – ${ticket || "Ticket"}`;
  const closeBody = [
    "The following ticket has been resolved:",
    "",
    `STATION NAME: ${station}`,
    `FAREGATE ID: ${fgid}`,
    `ISSUE DETAILS: ${issue}`,
    `ACTIONS TAKEN: ${actions}`,
    `FAREGATE STATUS: ${status}`,
    `CAUSE: ${cause}`,
    `TECHNICIAN: ${tech}`
  ].join("\n");

  // DAILY REPORT LINE (TAB-separated)
  const type = "Corrective";
  const dailyCols = [
    station,
    dtReportedTxt,
    dtDispatchTxt,
    dtArrivalTxt,
    duration,
    fgid,
    issue,
    status,
    tech,
    type,
    actions
  ];

  const trailingBlanks = 12;
  for(let i=0;i<trailingBlanks;i++) dailyCols.push("");

  const dailyLine = dailyCols.join("\t");

  $("dispatchPreview").textContent = `Subject: ${dispSub}\n\n${dispBody}`;
  $("closedPreview").textContent = `Subject: ${closeSub}\n\n${closeBody}`;
  $("dailyPreview").textContent = dailyLine;

  const to = $("toAddr").value.trim();
  const cc = computeCC();

  $("openDispatch").onclick = () => {
    if(!to){ setStatus("actionStatus", "Set the To (Google Group) first.", "err"); return; }
    window.open(gmailCompose(to, cc, dispSub, dispBody), "_blank");
  };

  $("openClosed").onclick = () => {
    if(!to){ setStatus("actionStatus", "Set the To (Google Group) first.", "err"); return; }
    window.open(gmailCompose(to, cc, closeSub, closeBody), "_blank");
  };

  $("copyDispatch").onclick = () => copyText($("dispatchPreview").textContent || "");
  $("copyClosed").onclick = () => copyText($("closedPreview").textContent || "");
  $("copyDaily").onclick = () => copyText(dailyLine);
}

/** ---------- Events ---------- **/
["ccg_nexien","ccg_metro","ccg_straffic","ccg_cubic","ccManual"].forEach(id=>{
  $(id).addEventListener("change", computeCC);
  $(id).addEventListener("input", computeCC);
});

// Gate filtering: update gates whenever station changes
$("station").addEventListener("input", () => setGatesForStation($("station").value.trim()));
$("station").addEventListener("change", () => setGatesForStation($("station").value.trim()));

// Normalize gate number on change/input (so selecting 00498 becomes 498)
$("fgid").addEventListener("change", () => { $("fgid").value = normalizeGateNumber($("fgid").value); });
$("fgid").addEventListener("blur",   () => { $("fgid").value = normalizeGateNumber($("fgid").value); });

// counts
$("count_nexien").textContent = `${CC_GROUPS.nexien.length} emails`;
$("count_metro").textContent = `${CC_GROUPS.metro.length} emails`;
$("count_straffic").textContent = `${CC_GROUPS.straffic.length} emails`;
$("count_cubic").textContent = `${CC_GROUPS.cubic.length} emails`;

$("savePrefs").onclick = savePrefs;
$("loadPrefs").onclick = () => { loadPrefs(); setStatus("prefStatus", "Reloaded.", "ok"); };
$("clearPrefs").onclick = clearPrefs;

$("openHelpdesk").onclick = () => window.open(gmailInbox(), "_blank");
$("build").onclick = build;

$("clearFields").onclick = () => {
  ["station","fgid","ticketId","dtReported","dtDispatch","dtArrival","issue","actions","cause"].forEach(id => $(id).value = "");
  $("tech").value = "";
  $("statusSel").value = "";
  $("dispatchPreview").textContent = "";
  $("closedPreview").textContent = "";
  $("dailyPreview").textContent = "";
  $("lineOut").textContent = "—";
  $("siteOut").textContent = "—";
  $("gateCountOut").textContent = "0";
  $("gates").innerHTML = "";
  setStatus("buildStatus", "Cleared ticket fields.", "ok");
  setStatus("actionStatus", "", "");
};

/** ---------- Init ---------- **/
parseSites();
populateStationDatalist();
loadPrefs();
computeCC();
setGatesForStation($("station").value.trim());
</script>
</body>
</html>
